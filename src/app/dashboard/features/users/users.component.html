<section class="min-h-[105vh] text-gray-600 mt-16">
  @let isLoading = store.isLoading();
  @let isFiltering = store.isFiltering();
  @let hasQuery = queryParams().q;
  @let userCount = store.users()[1];
  @let userList = store.users()[0];
  <!-- Loading State -->
  @if (isLoading && !isFiltering) {
    <div class="px-3 py-4 bg-white rounded-lg">
      <div class="flex items-start justify-between mb-8">
        <div class="flex flex-col gap-2">
          <div class="h-5 w-52 rounded-md bg-gray-200 animate-pulse"></div>
          <div class="flex items-center gap-1">
            <div class="h-6 w-56 rounded-md bg-gray-200 animate-pulse"></div>
            <div class="h-6 w-32 rounded-md bg-gray-200 animate-pulse"></div>
          </div>
        </div>
        <div class="h-5 w-40 rounded-md bg-gray-200 animate-pulse"></div>
      </div>
      <div class="grid grid-cols-4 overflow-x-auto">
        @for (i of skeletonArray; track $index) {
          <div class="border-y border-gray-200 py-3 px-2">
            <div class="h-4 rounded-md bg-gray-200 animate-pulse mb-2"></div>
          </div>
        }
      </div>
    </div>
  }
  <!-- Empty States -->
  @if (userCount === 0 && !isLoading) {
    <p class="pb-8">{{ hasQuery ? 'Aucun utilisateur trouvé avec ce filtre' : 'Aucun utilisateur trouvé' }}</p>
  }
  <!-- Main Content -->
  <div class="relative px-3 bg-white rounded-lg">
    <!-- Header Section -->
    <div class="flex flex-col flex-wrap gap-4 md:flex-row items-start justify-between px-2 py-6 mb-4">
      <div class="flex flex-col gap-2">
        <h5 class="text-lg font-bold">
          Liste des utilisateurs
          <span class="text-gray-500 text-sm">({{ userCount }})</span>
        </h5>
        <form [formGroup]="searchForm" (ngSubmit)="onSearch()" class="relative flex items-center gap-1">
          <input
            class="md:w-[300px]! py-1.5!"
            pInputText
            type="text"
            id="q"
            name="q"
            formControlName="q"
            autocomplete="none"
            placeholder="Rechercher..." />
          <button
            class="w-1/3!"
            pButton
            type="submit"
            [size]="'small'"
            [loading]="isFiltering"
            [disabled]="searchForm.invalid || isFiltering">
            @if (!isFiltering) {
              <i-lucide [name]="icons.search" class="size-4" />
            }
            Rechercher
          </button>
          <button
            class="w-1/3! transition-opacity duration-200"
            pButton
            [size]="'small'"
            [outlined]="true"
            [disabled]="!hasQuery || isFiltering"
            (click)="resetSearch()">
            <i-lucide [name]="icons.refresh" class="size-4" />
            Réinitialiser
          </button>
        </form>
      </div>
      <button
        class="md:w-1/5!"
        pButton
        [outlined]="true"
        [size]="'small'"
        [loading]="downloadStore.isLoading()"
        [disabled]="downloadStore.isLoading() || userCount === 0"
        (click)="downloadUsers()">
        @if (!downloadStore.isLoading()) {
          <i-lucide [name]="icons.download" class="size-4" />
        }
        Télécharger CSV
      </button>
    </div>
    <!-- Filtering Loading State -->
    @if (isFiltering) {
      <div class="grid grid-cols-4 overflow-x-auto">
        @for (i of skeletonArray; track $index) {
          <div class="border-y border-gray-200 py-3 px-2">
            <div class="h-4 rounded-md bg-gray-200 animate-pulse mb-2"></div>
          </div>
        }
      </div>
    }
    <!-- Users Table -->
    @if (userCount > 0 && !isLoading) {
      <div class="relative flex flex-col overflow-x-auto">
        <table class="text-sm text-left rtl:text-right text-gray-500">
          <thead class="text-sm text-gray-700 uppercase bg-gray-50">
            <tr>
              <th scope="col" class="px-4 py-2">Image</th>
              <th scope="col" class="px-4 py-2">Nom</th>
              <th scope="col" class="px-4 py-2">Email</th>
              <th scope="col" class="px-4 py-2">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (
              user of userList
                | paginate: { itemsPerPage: 20, currentPage: queryParams().page || 1, totalItems: userCount };
              track user.id
            ) {
              <tr class="odd:bg-white even:bg-gray-50 border-b border-gray-50">
                <td class="px-4 py-2">
                  <p-avatar [image]="user | apiIMG: 'user'" />
                </td>
                <th class="px-4 py-2 font-medium text-gray-900 whitespace-nowrap">
                  {{ user.name | titlecase }}
                </th>
                <td class="px-4 py-2">{{ user.email }}</td>
                <td class="px-4 py-2">
                  <div class="flex items-center gap-2">
                    <button>
                      <i-lucide [name]="icons.edit" class="size-4" />
                    </button>
                    <button>
                      <i-lucide [name]="icons.trash" class="size-4" />
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
  <!-- Pagination -->
  @if (userCount > 40) {
    <div class="flex justify-center items-center gap-3 mt-14">
      <pagination-controls
        nextLabel=""
        previousLabel=""
        [autoHide]="true"
        [maxSize]="5"
        (pageChange)="onPageChange($event)"
        class="pg">
      </pagination-controls>
    </div>
  }
</section>
